<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<!-- BEGIN opengraph metadata -->
<meta property="og:title" content="QuarkTS++ OS" />
<meta property="og:image" content="https://user-images.githubusercontent.com/11412210/235049017-242f1c64-52ef-46db-8008-2c3d8a578320.png" />
<meta property="og:description" content="An open-source OS for small embedded applications" />
<meta property="og:url" content="https://github.com/kmilo17pet/QuarkTS-cpp" />
<!-- END opengraph metadata -->
<!-- BEGIN twitter metadata -->
<meta name="twitter:image:src" content="https://repository-images.githubusercontent.com/348492097/4f16df80-88fb-11eb-9d31-4015ff22c452" />
<meta name="twitter:title" content="Doxygen Awesome" />
<meta name="twitter:description" content="Custom CSS theme for doxygen html-documentation with lots of customization parameters." />
<!-- END twitter metadata -->
<title>OS: Co-Routines</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" type="image/svg+xml" href="logo.drawio.svg"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="custom-alternative.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<a href="https://github.com/kmilo17pet/QuarkTS-cpp" class="github-corner" title="View source on GitHub" target="_blank">
    <svg viewBox="0 0 250 250" width="40" height="40" style="position: absolute; top: 0; border: 0; right: 0; z-index: 99;" aria-hidden="true">
    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="quarktslogo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">OS
   &#160;<span id="projectnumber">v1.3.5</span>
   </div>
   <div id="projectbrief">Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('q_qcoroutines.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Co-Routines </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#q_qcoroutines_overview">Overview</a></li>
<li class="level1"><a href="#q_coroutine_code">Coding a Co-Routine</a></li>
<li class="level1"><a href="#q_coroutine_blocking">Blocking calls in a Co-routine</a></li>
<li class="level1"><a href="#q_coroutine_example1">Co-Routine usage example</a></li>
<li class="level1"><a href="#q_coroutine_positions">Positional jumps</a></li>
<li class="level1"><a href="#q_coroutine_semaphores">Semaphores</a></li>
<li class="level1"><a href="#q_coroutine_example2">Co-Routine example with semaphores.</a></li>
<li class="level1"><a href="#q_coroutine_ext">External control</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="q_qcoroutines_overview"></a>
Overview</h1>
<p >A task coded as a Co-Routine, is just a task that allows multiple entry points for suspending and resuming execution at certain locations, this feature can bring benefits by improving the task cooperative scheme and providing a linear code execution for event-driven systems without complex state machines or full multithreading.</p>
<center>  
<!DOCTYPE html>
<html>
<head>
<title>coroutines++</title>
<meta charset="utf-8"/>
</head>
<body><div class="mxgraph" style="max-width:100%;border:1px solid transparent;" data-mxgraph="{&quot;highlight&quot;:&quot;#0000ff&quot;,&quot;nav&quot;:true,&quot;zoom&quot;:1.5,&quot;resize&quot;:true,&quot;toolbar&quot;:&quot;zoom layers tags lightbox&quot;,&quot;edit&quot;:&quot;_blank&quot;,&quot;xml&quot;:&quot;&lt;mxfile host=\&quot;app.diagrams.net\&quot; modified=\&quot;2023-05-05T15:39:02.820Z\&quot; agent=\&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36\&quot; etag=\&quot;mj9W_H0TDWNc1i3MwvPx\&quot; version=\&quot;21.2.3\&quot; type=\&quot;google\&quot;&gt;\n  &lt;diagram name=\&quot;PÃ¡gina-1\&quot; id=\&quot;OwHXzfAKBHHQWS32Xnqf\&quot;&gt;\n    &lt;mxGraphModel dx=\&quot;741\&quot; dy=\&quot;-37\&quot; grid=\&quot;1\&quot; gridSize=\&quot;10\&quot; guides=\&quot;1\&quot; tooltips=\&quot;1\&quot; connect=\&quot;1\&quot; arrows=\&quot;1\&quot; fold=\&quot;1\&quot; page=\&quot;1\&quot; pageScale=\&quot;1\&quot; pageWidth=\&quot;1169\&quot; pageHeight=\&quot;827\&quot; math=\&quot;0\&quot; shadow=\&quot;0\&quot;&gt;\n      &lt;root&gt;\n        &lt;mxCell id=\&quot;0\&quot; /&gt;\n        &lt;mxCell id=\&quot;1\&quot; parent=\&quot;0\&quot; /&gt;\n        &lt;mxCell id=\&quot;tTk1LmOXMArJNXh1joMB-1\&quot; value=\&quot;&amp;amp;nbsp;co::reenter() {&amp;lt;br&amp;gt;&amp;amp;nbsp; &amp;amp;nbsp; &amp;amp;nbsp;...&amp;lt;br&amp;gt;&amp;amp;nbsp; &amp;amp;nbsp; &amp;amp;nbsp;...&amp;lt;br&amp;gt;&amp;amp;nbsp; &amp;amp;nbsp; &amp;amp;nbsp;co::yield();&amp;lt;br&amp;gt;&amp;amp;nbsp; &amp;amp;nbsp; &amp;amp;nbsp;...&amp;lt;br&amp;gt;&amp;amp;nbsp; &amp;amp;nbsp; &amp;amp;nbsp;...&amp;lt;br&amp;gt;&amp;amp;nbsp; &amp;amp;nbsp; &amp;amp;nbsp;co::yield();&amp;lt;br&amp;gt;&amp;amp;nbsp; &amp;amp;nbsp; &amp;amp;nbsp;...&amp;lt;br&amp;gt;&amp;amp;nbsp;}\&quot; style=\&quot;rounded=0;whiteSpace=wrap;html=1;strokeColor=#007FFF;fillColor=none;fontFamily=Lucida Console;strokeWidth=2;fontColor=#808080;fontStyle=0;fontSize=10;align=left;\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;721\&quot; y=\&quot;1446\&quot; width=\&quot;138\&quot; height=\&quot;124\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;tTk1LmOXMArJNXh1joMB-2\&quot; value=\&quot;Task A\&quot; style=\&quot;rounded=0;whiteSpace=wrap;html=1;fillColor=#CCE5FF;fontColor=#808080;strokeColor=#007FFF;fillStyle=solid;fontFamily=Helvetica;strokeWidth=2;fontStyle=1\&quot; parent=\&quot;1\&quot; vertex=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;721\&quot; y=\&quot;1430\&quot; width=\&quot;138\&quot; height=\&quot;16\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;tTk1LmOXMArJNXh1joMB-5\&quot; value=\&quot;\&quot; style=\&quot;endArrow=blockThin;html=1;rounded=0;shadow=0;fontFamily=Lucida Console;fontSize=10;fontColor=#B3B3B3;strokeColor=#808080;strokeWidth=1;startArrow=oval;startFill=1;endFill=1;exitX=1;exitY=0.75;exitDx=0;exitDy=0;\&quot; parent=\&quot;1\&quot; edge=\&quot;1\&quot;&gt;\n          &lt;mxGeometry width=\&quot;50\&quot; height=\&quot;50\&quot; relative=\&quot;1\&quot; as=\&quot;geometry\&quot;&gt;\n            &lt;mxPoint x=\&quot;845.0000000000002\&quot; y=\&quot;1461.4399999999998\&quot; as=\&quot;sourcePoint\&quot; /&gt;\n            &lt;mxPoint x=\&quot;845\&quot; y=\&quot;1560\&quot; as=\&quot;targetPoint\&quot; /&gt;\n            &lt;Array as=\&quot;points\&quot;&gt;\n              &lt;mxPoint x=\&quot;845\&quot; y=\&quot;1490\&quot; /&gt;\n              &lt;mxPoint x=\&quot;925\&quot; y=\&quot;1461\&quot; /&gt;\n              &lt;mxPoint x=\&quot;925\&quot; y=\&quot;1500\&quot; /&gt;\n              &lt;mxPoint x=\&quot;845\&quot; y=\&quot;1500\&quot; /&gt;\n              &lt;mxPoint x=\&quot;845\&quot; y=\&quot;1530\&quot; /&gt;\n              &lt;mxPoint x=\&quot;925\&quot; y=\&quot;1510\&quot; /&gt;\n              &lt;mxPoint x=\&quot;925\&quot; y=\&quot;1550\&quot; /&gt;\n              &lt;mxPoint x=\&quot;845\&quot; y=\&quot;1540\&quot; /&gt;\n            &lt;/Array&gt;\n          &lt;/mxGeometry&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;TdvfbX77WpDKRGBcznC6-2\&quot; value=\&quot;&amp;amp;nbsp;co::reenter() {&amp;lt;br style=&amp;quot;border-color: var(--border-color);&amp;quot;&amp;gt;&amp;amp;nbsp; &amp;amp;nbsp; &amp;amp;nbsp;...&amp;lt;br style=&amp;quot;border-color: var(--border-color);&amp;quot;&amp;gt;&amp;amp;nbsp; &amp;amp;nbsp; &amp;amp;nbsp;...&amp;lt;br style=&amp;quot;border-color: var(--border-color);&amp;quot;&amp;gt;&amp;amp;nbsp; &amp;amp;nbsp; &amp;amp;nbsp;...&amp;lt;br style=&amp;quot;border-color: var(--border-color);&amp;quot;&amp;gt;&amp;amp;nbsp; &amp;amp;nbsp; &amp;amp;nbsp;co::yield();&amp;lt;br style=&amp;quot;border-color: var(--border-color);&amp;quot;&amp;gt;&amp;amp;nbsp; &amp;amp;nbsp; &amp;amp;nbsp;...&amp;lt;br style=&amp;quot;border-color: var(--border-color);&amp;quot;&amp;gt;&amp;amp;nbsp; &amp;amp;nbsp; &amp;amp;nbsp;...&amp;lt;br style=&amp;quot;border-color: var(--border-color);&amp;quot;&amp;gt;&amp;amp;nbsp; &amp;amp;nbsp; &amp;amp;nbsp;...&amp;lt;br style=&amp;quot;border-color: var(--border-color);&amp;quot;&amp;gt;&amp;amp;nbsp; &amp;amp;nbsp; &amp;amp;nbsp;...&amp;lt;br style=&amp;quot;border-color: var(--border-color);&amp;quot;&amp;gt;&amp;amp;nbsp;}\&quot; style=\&quot;rounded=0;whiteSpace=wrap;html=1;strokeColor=#007FFF;fillColor=none;fontFamily=Lucida Console;strokeWidth=2;fontColor=#808080;fontStyle=0;fontSize=10;align=left;\&quot; vertex=\&quot;1\&quot; parent=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;917\&quot; y=\&quot;1446\&quot; width=\&quot;138\&quot; height=\&quot;124\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n        &lt;mxCell id=\&quot;TdvfbX77WpDKRGBcznC6-4\&quot; value=\&quot;Task B\&quot; style=\&quot;rounded=0;whiteSpace=wrap;html=1;fillColor=#CCE5FF;fontColor=#808080;strokeColor=#007FFF;fillStyle=solid;fontFamily=Helvetica;strokeWidth=2;fontStyle=1\&quot; vertex=\&quot;1\&quot; parent=\&quot;1\&quot;&gt;\n          &lt;mxGeometry x=\&quot;917\&quot; y=\&quot;1430\&quot; width=\&quot;138\&quot; height=\&quot;16\&quot; as=\&quot;geometry\&quot; /&gt;\n        &lt;/mxCell&gt;\n      &lt;/root&gt;\n    &lt;/mxGraphModel&gt;\n  &lt;/diagram&gt;\n&lt;/mxfile&gt;\n&quot;}"></div>
<script type="text/javascript" src="https://viewer.diagrams.net/js/viewer-static.min.js"></script>
</body>
</html>
 <em>Coroutines in QuarkTS++</em> </center><p >The QuarkTS++ implementation is stackless by using the Duff's device approach, and is heavily inspired by the Knuth method, <a href="https://www.chiark.greenend.org.uk/~sgtatham/coroutines.html" style="font-weight:bold">Simon Tatham's Co-Routines in C</a> and <a href="http://dunkels.com/adam/pt/index.html" style="font-weight:bold">Adam Dunkels Protothreads</a> . This means that a local-continuation variable is used to preserve the current state of execution at a particular place of the Co-Routine scope but without any call history or local variables. This brings benefits to lower RAM usage, but at the cost of some restrictions on how a Co-routine can be used.</p>
<p ><b> Limitations and restrictions </b></p>
<ul>
<li>The stack of a Co-Routine is not maintained when a yield is performed. This means variables allocated on the stack will loose their values. To overcome this, a variable that must maintain its value across a blocking call must be declared as <code>static</code>.</li>
<li>Calls to API functions that could cause the Co-Routine to block, can only be made from the Co-Routine function itself - not from within a function called by the Co-Routine.</li>
<li>The implementation does not permit yielding or blocking calls to be made from within a <code>switch</code> statement.</li>
</ul>
<h1><a class="anchor" id="q_coroutine_code"></a>
Coding a Co-Routine</h1>
<p >The application writer just needs to create the body of the Co-Routine . This means starting a Co-Routine segment with <a class="el" href="group__qcoroutines.html#gabb86ebfd79f14350a9ed1be1a44f3b91" title="Defines a Coroutine segment. The co::reenter() statement is used to declare the starting point of a C...">co::reenter()</a> statement . From now on, yields and blocking calls from the Co-Routine scope are allowed.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> CoroutineTask_Callback( event_t e ) {</div>
<div class="line">    <a class="code hl_function" href="group__qcoroutines.html#gabb86ebfd79f14350a9ed1be1a44f3b91">co::reenter</a>() {</div>
<div class="line">        <span class="keywordflow">for</span> (;;) {</div>
<div class="line">            <span class="keywordflow">if</span> ( EventNotComing() ) {</div>
<div class="line">                <a class="code hl_function" href="group__qcoroutines.html#gaa0ac1583601848da679af80f593b1cff">co::yield</a>();</div>
<div class="line">            }</div>
<div class="line">            DoTheEventProcessing();</div>
<div class="line">            <a class="code hl_function" href="group__qcoroutines.html#ga3ba35f233837d549d971632444e00c06">co::delay</a>( WAIT_TIME_MS );</div>
<div class="line">            PerformActions();</div>
<div class="line">       }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="agroup__qcoroutines_html_ga3ba35f233837d549d971632444e00c06"><div class="ttname"><a href="group__qcoroutines.html#ga3ba35f233837d549d971632444e00c06">qOS::co::delay</a></div><div class="ttdeci">void delay(qOS::duration_t t) noexcept</div><div class="ttdoc">Delay a coroutine for a given number of time.</div><div class="ttdef"><b>Definition:</b> coroutine.hpp:219</div></div>
<div class="ttc" id="agroup__qcoroutines_html_gaa0ac1583601848da679af80f593b1cff"><div class="ttname"><a href="group__qcoroutines.html#gaa0ac1583601848da679af80f593b1cff">qOS::co::yield</a></div><div class="ttdeci">void yield(void) noexcept</div><div class="ttdoc">This statement is only allowed inside a Coroutine segment. co::yield return the CPU control back to t...</div><div class="ttdef"><b>Definition:</b> coroutine.hpp:213</div></div>
<div class="ttc" id="agroup__qcoroutines_html_gabb86ebfd79f14350a9ed1be1a44f3b91"><div class="ttname"><a href="group__qcoroutines.html#gabb86ebfd79f14350a9ed1be1a44f3b91">qOS::co::reenter</a></div><div class="ttdeci">void reenter(void) noexcept</div><div class="ttdoc">Defines a Coroutine segment. The co::reenter() statement is used to declare the starting point of a C...</div><div class="ttdef"><b>Definition:</b> coroutine.hpp:187</div></div>
</div><!-- fragment --><p >The <a class="el" href="group__qcoroutines.html#gabb86ebfd79f14350a9ed1be1a44f3b91" title="Defines a Coroutine segment. The co::reenter() statement is used to declare the starting point of a C...">co::reenter()</a> statement should be placed at the start of the task function in which the Co-routine runs.</p>
<p >A <a class="el" href="group__qcoroutines.html#gaa0ac1583601848da679af80f593b1cff" title="This statement is only allowed inside a Coroutine segment. co::yield return the CPU control back to t...">co::yield()</a> statement return the CPU control back to the scheduler but saving the execution progress, thereby allowing other processing tasks to take place in the system. With the next task activation, the Co-Routine will resume the execution after the last <a class="el" href="group__qcoroutines.html#gaa0ac1583601848da679af80f593b1cff" title="This statement is only allowed inside a Coroutine segment. co::yield return the CPU control back to t...">co::yield()</a> statement.</p>
<dl class="section note"><dt>Note</dt><dd>Co-Routine statements can only be invoked from the scope of the Co-Routine. </dd></dl>
<dl class="section remark"><dt>Remarks</dt><dd>You should put an endless-loop inside a Co-routine, this behavior is not hardcoded within the segment definition.</dd></dl>
<h1><a class="anchor" id="q_coroutine_blocking"></a>
Blocking calls in a Co-routine</h1>
<p >Blocking calls inside a Co-Routine should be made with the provided statements, all of them with a common feature: an implicit yield.</p>
<p >A widely used procedure is to wait for a fixed period of time. For this, the <a class="el" href="group__qcoroutines.html#ga3ba35f233837d549d971632444e00c06" title="Delay a coroutine for a given number of time.">co::delay()</a> should be used. This statement makes an apparent blocking over the application flow, but to be precise, a yield is performed until the requested time expires, this allows other tasks to be executed until the blocking call finish. This "yielding until condition meet" behavior its the common pattern among the other blocking statements.</p>
<p >Another common blocking call is <a class="el" href="group__qcoroutines.html#gad0eca0c65e03d038bb7374ee75980f20" title="Yields until the logical condition is met.">co::waitUntil()</a>. This statement takes a condition argument, a logical expression that will be performed when the Co-Routine resumes their execution. As mentioned before, this type of statement exposes the expected behavior, yielding until the condition is met.</p>
<p >An additional overload of this <a class="el" href="group__qcoroutines.html#gad0eca0c65e03d038bb7374ee75980f20" title="Yields until the logical condition is met.">co::waitUntil()</a> is also provided. This one sets a timeout for the logical condition to be met.</p>
<p >Optionally, the perform-until structure gives to application writer the ability to perform a multi-line job before the yield, allowing more complex actions to being performed after the Co-Routine resumes:</p>
<div class="fragment"><div class="line"><a class="code hl_function" href="group__qcoroutines.html#ga8580564fbde2487440f6e1606a0750d4">co::perform</a>() {</div>
<div class="line">    <span class="comment">/*Job : a set of instructions */</span></div>
<div class="line">} <a class="code hl_function" href="group__qcoroutines.html#ga98a70f2deb294a8e2161eb07df049835">co::until</a>( condition );</div>
<div class="ttc" id="agroup__qcoroutines_html_ga8580564fbde2487440f6e1606a0750d4"><div class="ttname"><a href="group__qcoroutines.html#ga8580564fbde2487440f6e1606a0750d4">qOS::co::perform</a></div><div class="ttdeci">void perform(void) noexcept</div><div class="ttdoc">This statement start a blocking Job segment.</div><div class="ttdef"><b>Definition:</b> coroutine.hpp:322</div></div>
<div class="ttc" id="agroup__qcoroutines_html_ga98a70f2deb294a8e2161eb07df049835"><div class="ttname"><a href="group__qcoroutines.html#ga98a70f2deb294a8e2161eb07df049835">qOS::co::until</a></div><div class="ttdeci">void until(bool condition) noexcept</div><div class="ttdoc">This statement ends a blocking Job segment starting with the co::perform() statement.</div><div class="ttdef"><b>Definition:</b> coroutine.hpp:355</div></div>
</div><!-- fragment --><dl class="section warning"><dt>Warning</dt><dd>Co-routines statements are not allowed within the job segment.</dd></dl>
<h1><a class="anchor" id="q_coroutine_example1"></a>
Co-Routine usage example</h1>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Sender_Task( event_t e ) {</div>
<div class="line">    <a class="code hl_function" href="group__qcoroutines.html#gabb86ebfd79f14350a9ed1be1a44f3b91">co::reenter</a>() {</div>
<div class="line">        Send_Packet();</div>
<div class="line">        <span class="comment">/* Wait until an acknowledgment has been received, or until</span></div>
<div class="line"><span class="comment">         * the timer expires. If the timer expires, we should send</span></div>
<div class="line"><span class="comment">         * the packet again.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <a class="code hl_function" href="group__qcoroutines.html#gad0eca0c65e03d038bb7374ee75980f20">co::waitUntil</a>( PacketACK_Received(), TIMEOUT_TIME );</div>
<div class="line">        <a class="code hl_function" href="group__qcoroutines.html#ga13055a9326fa8e11d527715fadc7b528">co::restart</a>(); </div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*===================================================================*/</span></div>
<div class="line"><span class="keywordtype">void</span> Receiver_Task( event_t e ) {</div>
<div class="line">    <a class="code hl_function" href="group__qcoroutines.html#gabb86ebfd79f14350a9ed1be1a44f3b91">co::reenter</a>() {</div>
<div class="line">        <span class="comment">/* Wait until a packet has been received*/</span></div>
<div class="line">        <a class="code hl_function" href="group__qcoroutines.html#gad0eca0c65e03d038bb7374ee75980f20">co::waitUntil</a>( Packet_Received() );</div>
<div class="line">        Send_Acknowledgement();</div>
<div class="line">        <a class="code hl_function" href="group__qcoroutines.html#ga13055a9326fa8e11d527715fadc7b528">co::restart</a>(); </div>
<div class="line">    };</div>
<div class="line">}</div>
<div class="ttc" id="agroup__qcoroutines_html_ga13055a9326fa8e11d527715fadc7b528"><div class="ttname"><a href="group__qcoroutines.html#ga13055a9326fa8e11d527715fadc7b528">qOS::co::restart</a></div><div class="ttdeci">void restart(void) noexcept</div><div class="ttdoc">This statement cause the running Coroutine to restart its execution at the place of the co::reenter()...</div><div class="ttdef"><b>Definition:</b> coroutine.hpp:271</div></div>
<div class="ttc" id="agroup__qcoroutines_html_gad0eca0c65e03d038bb7374ee75980f20"><div class="ttname"><a href="group__qcoroutines.html#gad0eca0c65e03d038bb7374ee75980f20">qOS::co::waitUntil</a></div><div class="ttdeci">void waitUntil(bool condition) noexcept</div><div class="ttdoc">Yields until the logical condition is met.</div><div class="ttdef"><b>Definition:</b> coroutine.hpp:233</div></div>
</div><!-- fragment --><h1><a class="anchor" id="q_coroutine_positions"></a>
Positional jumps</h1>
<p >This feature provides positional local jumps, control flow that deviates from the usual Co-Routine call.</p>
<p >The complementary statements <a class="el" href="group__qcoroutines.html#gac8354b5da4ab66b7e049c615af830c97" title="Labels the current position and saves it to var so it can be later restored by co::setPosition()">co::getPosition()</a> and <a class="el" href="group__qcoroutines.html#gacf586fa36242eee6bcb2aa4052eb56dc" title="Restores the Co-Routine position saved in var.">co::setPosition()</a> provide this functionality. The first one saves the Co-Routine state at some point of their execution into <code>CRPos</code>, a variable of type <a class="el" href="classq_o_s_1_1co_1_1position.html" title="A placeholder for the Co-Routine current position or progress.">qOS::co::position</a> , that can be used at some later point of program execution by <a class="el" href="group__qcoroutines.html#gacf586fa36242eee6bcb2aa4052eb56dc" title="Restores the Co-Routine position saved in var.">co::setPosition()</a> to restore the Co-Routine state to the one saved by <a class="el" href="group__qcoroutines.html#gac8354b5da4ab66b7e049c615af830c97" title="Labels the current position and saves it to var so it can be later restored by co::setPosition()">co::getPosition()</a> into CRPos. This process can be imagined to be a "jump" back to the point of program execution where <a class="el" href="group__qcoroutines.html#gac8354b5da4ab66b7e049c615af830c97" title="Labels the current position and saves it to var so it can be later restored by co::setPosition()">co::getPosition()</a> saved the Co-Routine environment.</p>
<h1><a class="anchor" id="q_coroutine_semaphores"></a>
Semaphores</h1>
<p >This extension implements counting semaphores on top of Co-Routines. Semaphores are a synchronization primitive that provide two operations: <em>wait</em> and <em>signal</em>. The <em>wait</em> operation checks the semaphore counter and blocks the Co-Routine if the counter is zero. The <em>signal</em> operation increases the semaphore counter but does not block. If another Co-Routine has blocked waiting for the semaphore that is signaled, the blocked Co-Routines will become runnable again.</p>
<p >Semaphores are referenced by handles, a variable of type co::semaphore and must be initialized at time of creating with its own constructor. Here, a value for the counter is required. Internally, semaphores use an <code>size_t</code> to represent the counter, therefore the value argument should be within range of this data-type.</p>
<p >To perform the |a wait operation, the <a class="el" href="group__qcoroutines.html#ga8f2e9cbda9ba9df1f8a756ab212e8302" title="Carries out the &quot;wait&quot; operation on the semaphore. The wait operation causes the Co-routine to block ...">co::semWait()</a> statement should be used. The wait operation causes the Co-routine to block while the counter is zero. When the counter reaches a value larger than zero, the Co-Routine will continue.</p>
<p >Finally, <a class="el" href="group__qcoroutines.html#gae5fa49283e366f3201de3fe515f5caae" title="Carries out the &quot;signal&quot; operation on the semaphore. The signal operation increments the counter insi...">co::semSignal()</a> carries out the <em>signal</em> operation on the semaphore. This signaling increments the counter inside the semaphore, which eventually will cause waiting Coroutines to continue executing.</p>
<h1><a class="anchor" id="q_coroutine_example2"></a>
Co-Routine example with semaphores.</h1>
<p >The following example shows how to implement the bounded buffer problem using Co-Routines and semaphores. The example uses two tasks: one that produces items and other that consumes items.</p>
<p >Note that there is no need for a mutex to guard the <code>add_to_buffer()</code> and <code>get_from_buffer()</code> functions because of the implicit locking semantics of Co-Routines, so it will never be preempted and will never block except in an explicit <a class="el" href="group__qcoroutines.html#ga8f2e9cbda9ba9df1f8a756ab212e8302" title="Carries out the &quot;wait&quot; operation on the semaphore. The wait operation causes the Co-routine to block ...">co::semWait()</a> statement.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;HAL.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;QuarkTS.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;AppLibrary.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespaceq_o_s.html">qOS</a>;</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define NUM_ITEMS    ( 32 )</span></div>
<div class="line"><span class="preprocessor">#define BUFSIZE      ( 8 )</span></div>
<div class="line"> </div>
<div class="line">task_t ProducerTask, ConsumerTask;</div>
<div class="line">co::semaphore mutex( 1 ), full( BUFSIZE ), empty( 0 );</div>
<div class="line"><span class="comment">/*===================================================================*/</span></div>
<div class="line"><span class="keywordtype">void</span> ProducerTask_Callback( event_t e ) {</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">int</span> produced;</div>
<div class="line">    </div>
<div class="line">    <a class="code hl_function" href="group__qcoroutines.html#gabb86ebfd79f14350a9ed1be1a44f3b91">co::reenter</a>() {</div>
<div class="line">        <span class="keywordflow">for</span> ( produced = 0 ; produced &lt; NUM_ITEMS ; ++produced ) {</div>
<div class="line">            <a class="code hl_function" href="group__qcoroutines.html#ga8f2e9cbda9ba9df1f8a756ab212e8302">co::semWait</a>( full );</div>
<div class="line">            <a class="code hl_function" href="group__qcoroutines.html#ga8f2e9cbda9ba9df1f8a756ab212e8302">co::semWait</a>( mutex );</div>
<div class="line"> </div>
<div class="line">            add_to_buffer( produce_item() );</div>
<div class="line"> </div>
<div class="line">            <a class="code hl_function" href="group__qcoroutines.html#gae5fa49283e366f3201de3fe515f5caae">co::semSignal</a>( mutex );</div>
<div class="line">            <a class="code hl_function" href="group__qcoroutines.html#gae5fa49283e366f3201de3fe515f5caae">co::semSignal</a>( empty );</div>
<div class="line">        }</div>
<div class="line">        <a class="code hl_function" href="group__qcoroutines.html#ga13055a9326fa8e11d527715fadc7b528">co::restart</a>();</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*===================================================================*/</span></div>
<div class="line"><span class="keywordtype">void</span> ConsumerTask_Callback( event_t e ) {</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">int</span> consumed;</div>
<div class="line">    </div>
<div class="line">    <a class="code hl_function" href="group__qcoroutines.html#gabb86ebfd79f14350a9ed1be1a44f3b91">co::reenter</a>() {</div>
<div class="line">        <span class="keywordflow">for</span> ( consumed = 0 ; consumed &lt; NUM_ITEMS ; ++consumed ) {</div>
<div class="line">            <a class="code hl_function" href="group__qcoroutines.html#ga8f2e9cbda9ba9df1f8a756ab212e8302">co::semWait</a>( empty );</div>
<div class="line">            <a class="code hl_function" href="group__qcoroutines.html#ga8f2e9cbda9ba9df1f8a756ab212e8302">co::semWait</a>( mutex );</div>
<div class="line">    </div>
<div class="line">            consume_item( get_from_buffer() );</div>
<div class="line">            <a class="code hl_function" href="group__qcoroutines.html#gae5fa49283e366f3201de3fe515f5caae">co::semSignal</a>( mutex );</div>
<div class="line">            <a class="code hl_function" href="group__qcoroutines.html#gae5fa49283e366f3201de3fe515f5caae">co::semSignal</a>( full );</div>
<div class="line">        }</div>
<div class="line">    };</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*===================================================================*/</span></div>
<div class="line"><span class="keywordtype">void</span> IdleTask_Callback( event_t e ) {</div>
<div class="line">    <span class="comment">/*nothing to do*/</span></div>
<div class="line">} </div>
<div class="line"><span class="comment">/*===================================================================*/</span></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>) {</div>
<div class="line">    HAL_Init();</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_variable" href="group__qtaskcreation.html#gaefc7088d1435e64e433d09541fae505c">os</a>.<a class="code hl_function" href="classq_o_s_1_1core.html#a76bcdcfaba5020967caff19f69f4270a">init</a>( HAL_GetTick, IdleTask_Callback );</div>
<div class="line">    </div>
<div class="line">    <a class="code hl_variable" href="group__qtaskcreation.html#gaefc7088d1435e64e433d09541fae505c">os</a>.<a class="code hl_function" href="classq_o_s_1_1core.html#a615f44cfc4f4b4963b2b4cbb044ab76b">addTask</a>( ProducerTask, ProducerTask_Callback, core::MEDIUM_PRIORITY, </div>
<div class="line">                100_ms, task::PERIODIC, taskState::ENABLED );</div>
<div class="line">    <a class="code hl_variable" href="group__qtaskcreation.html#gaefc7088d1435e64e433d09541fae505c">os</a>.<a class="code hl_function" href="classq_o_s_1_1core.html#a615f44cfc4f4b4963b2b4cbb044ab76b">addTask</a>( ConsumerTask, ConsumerTask_Callback, core::MEDIUM_PRIORITY, </div>
<div class="line">                100_ms, task::PERIODIC, taskState::ENABLED );</div>
<div class="line">    <a class="code hl_variable" href="group__qtaskcreation.html#gaefc7088d1435e64e433d09541fae505c">os</a>.<a class="code hl_function" href="classq_o_s_1_1core.html#a30b4c1ac78976e2d289a710647300d5c">run</a>();</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aclassq_o_s_1_1core_html_a30b4c1ac78976e2d289a710647300d5c"><div class="ttname"><a href="classq_o_s_1_1core.html#a30b4c1ac78976e2d289a710647300d5c">qOS::core::run</a></div><div class="ttdeci">bool run(void) noexcept</div><div class="ttdoc">Executes the scheduling scheme. It must be called once after the task pool has been defined.</div></div>
<div class="ttc" id="aclassq_o_s_1_1core_html_a615f44cfc4f4b4963b2b4cbb044ab76b"><div class="ttname"><a href="classq_o_s_1_1core.html#a615f44cfc4f4b4963b2b4cbb044ab76b">qOS::core::addTask</a></div><div class="ttdeci">bool addTask(task &amp;Task, taskFcn_t callback, const priority_t p, const duration_t t, const iteration_t n, const taskState s=taskState::ENABLED_STATE, void *arg=nullptr) noexcept</div><div class="ttdoc">Add a task to the scheduling scheme. The task is scheduled to run every t time units,...</div></div>
<div class="ttc" id="aclassq_o_s_1_1core_html_a76bcdcfaba5020967caff19f69f4270a"><div class="ttname"><a href="classq_o_s_1_1core.html#a76bcdcfaba5020967caff19f69f4270a">qOS::core::init</a></div><div class="ttdeci">void init(const getTickFcn_t tFcn=nullptr, taskFcn_t callbackIdle=nullptr) noexcept</div><div class="ttdoc">Task Scheduler initialization. This core method is required and must be called once in the applicatio...</div></div>
<div class="ttc" id="agroup__qcoroutines_html_ga8f2e9cbda9ba9df1f8a756ab212e8302"><div class="ttname"><a href="group__qcoroutines.html#ga8f2e9cbda9ba9df1f8a756ab212e8302">qOS::co::semWait</a></div><div class="ttdeci">void semWait(co::semaphore &amp;sem) noexcept</div><div class="ttdoc">Carries out the &quot;wait&quot; operation on the semaphore. The wait operation causes the Co-routine to block ...</div><div class="ttdef"><b>Definition:</b> coroutine.hpp:280</div></div>
<div class="ttc" id="agroup__qcoroutines_html_gae5fa49283e366f3201de3fe515f5caae"><div class="ttname"><a href="group__qcoroutines.html#gae5fa49283e366f3201de3fe515f5caae">qOS::co::semSignal</a></div><div class="ttdeci">void semSignal(co::semaphore &amp;sem) noexcept</div><div class="ttdoc">Carries out the &quot;signal&quot; operation on the semaphore. The signal operation increments the counter insi...</div><div class="ttdef"><b>Definition:</b> coroutine.hpp:290</div></div>
<div class="ttc" id="agroup__qtaskcreation_html_gaefc7088d1435e64e433d09541fae505c"><div class="ttname"><a href="group__qtaskcreation.html#gaefc7088d1435e64e433d09541fae505c">qOS::os</a></div><div class="ttdeci">core &amp; os</div><div class="ttdoc">The predefined instance of the OS kernel interface.</div></div>
<div class="ttc" id="anamespaceq_o_s_html"><div class="ttname"><a href="namespaceq_o_s.html">qOS</a></div><div class="ttdoc">OS/Kernel interfaces.</div><div class="ttdef"><b>Definition:</b> bytebuffer.hpp:7</div></div>
</div><!-- fragment --><h1><a class="anchor" id="q_coroutine_ext"></a>
External control</h1>
<p >In certain situations, it may be necessary to control the flow of execution outside of the segment that defines the Co-routine itself. This is typically done to defer or resume the Co-routine in response to specific occurrences that arise in other contexts, such as tasks or interrupts.</p>
<p >To address these specific scenarios, a handler for the Co-routine must be defined, which is a variable of type <a class="el" href="classq_o_s_1_1co_1_1handle.html" title="A Co-Routine handle.">qOS::co::handle</a>. Additionally, to initiate the scope of the target Co-routine, the statement <a class="el" href="group__qcoroutines.html#gabb86ebfd79f14350a9ed1be1a44f3b91" title="Defines a Coroutine segment. The co::reenter() statement is used to declare the starting point of a C...">co::reenter()</a> should be used taking this handler as argument.</p>
<div class="fragment"><div class="line">co::handle xHandleCR;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*===================================================================*/</span></div>
<div class="line"><span class="keywordtype">void</span> AnotherTask_Callback( event_t e ) {</div>
<div class="line">    <span class="keywordtype">int</span> UserInput = 0;</div>
<div class="line">    <span class="keywordflow">if</span> ( e.firstIteration() ) {</div>
<div class="line">        xHandleCR.try_resume();</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> ( e.lastIteration() ) {</div>
<div class="line">        xHandleCR.try_suspend();</div>
<div class="line">    }</div>
<div class="line">    UserInput = GetTerminalInput();</div>
<div class="line">    <span class="keywordflow">if</span> ( UserInput == USR_RESTART ) {</div>
<div class="line">        xHandleCR.try_restart();</div>
<div class="line">    }</div>
<div class="line">    Perform_AnotherTask_Activities();</div>
<div class="line">}</div>
<div class="line"><span class="comment">/*===================================================================*/</span></div>
<div class="line"><span class="keywordtype">void</span> CoroutineTask_Callback( event_t e ) {</div>
<div class="line">    <a class="code hl_function" href="group__qcoroutines.html#gabb86ebfd79f14350a9ed1be1a44f3b91">co::reenter</a>( xHandleCR ) { <span class="comment">/*externally controlled*/</span></div>
<div class="line">        <span class="keywordflow">for</span>(;;) {</div>
<div class="line">            <span class="keywordflow">if</span> ( EventNotComing() ) {</div>
<div class="line">                <a class="code hl_function" href="group__qcoroutines.html#gaa0ac1583601848da679af80f593b1cff">co::yield</a>();</div>
<div class="line">            }</div>
<div class="line">            RunFirstJob();</div>
<div class="line">            <a class="code hl_function" href="group__qcoroutines.html#ga3ba35f233837d549d971632444e00c06">co::delay</a>( WAIT_TIME );</div>
<div class="line">            SecondJobStatus = RunSecondJob();</div>
<div class="line">            <a class="code hl_function" href="group__qcoroutines.html#gad0eca0c65e03d038bb7374ee75980f20">co::waitUntil</a>( JobFlag == JOB_SUCCESS, JOB_TIMEOUT );</div>
<div class="line">            CleanUpStatus = CleanupJob();</div>
<div class="line">            <a class="code hl_function" href="group__qcoroutines.html#gad0eca0c65e03d038bb7374ee75980f20">co::waitUntil</a>( SomeVar &gt; SomeValue );</div>
<div class="line">        }</div>
<div class="line">    };</div>
<div class="line">}</div>
</div><!-- fragment --><p >As shown in the code snippet above, the Co-routine handle its globally declared to enable other contexts to access it. The example demonstrates how another task can control the Coroutine using the "try_" methods. It's important to note that the actions performed by this API can only be effective after the handle instantiation, which is a one-time operation that occurs during the first call of the Co-routine. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="q_extensions.html">Extensions</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2 </li>
  </ul>
</div>
</body>
</html>
